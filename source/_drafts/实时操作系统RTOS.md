---
title: 实时操作系统RTOS
mathjax: true
date: 2020-11-24 18:00:27
tags:
- 嵌入式
categories: 校内课程
---

嵌入式系统课程记录，实时操作系统RTOS简介

<!-- more -->


## RTOS基本概念

**操作系统用来解决资源分配问题**

**实时性realtime**：在可预测可保证的时间内做出对事件的反应

底盘域控制器和自动驾驶域控制器的要求

- 硬实时：错了就崩溃
- 软实时

1. 前/后台系统

前台是中断，后台是一个循环，容易实现，响应慢且时间不确定

2. 不可剥夺型内核

内核是对CPU调用的一段小程序

不会有高优先级的任务抢夺CPU资源，可使用不可重入函数，无需保护共享资源，时间不确定

3. 可剥夺型内核

时间确定，响应时间最优化（高优先级可打断）

### RTOS分类

商业：VxWorks，Windows，CE
免费：Linux，uC/OS-II

### 使用代价

1. 内核的价格
2. ROM/RAM的额外开销
3. 2%-4%的CPU开销


## uC/OS-II实时系统

两周内完成MCU移植

- 任务管理
- 时间管理
- 内存管理
- 事件管理

### 概念
实时内核：
1. 多任务系统中，管理任务
2. 基本任务是任务切换

**内核结构**
- 用户层
- 与应用相关
- 与控制器无关代码
- 与控制器相关代码（移植）

**任务**
- 也称作线程，OS调度的基本对象，CPU完全属于该程序自己
- 具有一定的优先级，有单独的堆栈和寄存器
- 典型任务是一个无限循环
- 状态：休眠（不参与调度）、就绪（只差CPU的时候）、运行、等待（等触发，除CPU外还有其余条件如IO）

**多任务**
- 提高CPU的利用率
- 带来死锁和重入的问题

死锁：两个任务无限期的相互等待对方控制的资源
重入：可重入函数可被一个以上任务调用而不担心数据被破坏；

**任务调度算法**
- 优先级调度：绝大多数RTOS，uC/OS-II（Event-triggered）
- 分时调度系统：Linux/UNIX（Time-triggered）

**优先级**
- 静态优先级：在编译的时候确定了优先级
- 动态优先级：执行中优先级动态可变

- uC/OS-II可以管理至多64个任务，最高的4个和最低的4个为内核保留任务
- 数值越低，优先级越高
- 空闲任务system idle process：63 统计任务：62
- 动态调节优先级
- 任务的优先级号也是标识符

### 任务切换
任务建立
- 任务进入就绪态
- 任务不能由ISR（中断服务程序）建立

任务堆栈
- 由连续的存储空间组成
- 静态/动态分配

任务删除
- 任务返回休眠态
- 任务必须自我删除

切换过程与中断类似，需要保存现场，修改新任务的地址，不同在于任务优先级是人工编写确定的

