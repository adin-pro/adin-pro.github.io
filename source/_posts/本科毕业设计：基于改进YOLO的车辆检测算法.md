---
title: 本科毕业设计：基于改进YOLO的车辆检测算法
mathjax: true
date: 2020-06-13 20:02:38
tags:
- 论文
- 校内课程
categories: 论文
---

2020年6月9日完成了本科毕业设计的答辩工作，在此将毕业设计论文做一个记录和留存。

毕业设计的主题是车辆检测算法，主要内容是对轻量化网络YOLOv3-Tiny进行的改进工作。一开始是从YOLOv3入手的，后来受限于算力不足，就把方向改成了做轻量化算法，，为了丰富内容，在Nvidia Jetson Nano上做实时性验证。毕业设计做到一半YOLOv4出来了，颇有一种官方逼死同人的感觉哈哈哈哈哈。

<!-- more -->

## 摘 要

驾驶辅助系统和自动驾驶系统可以有效提升车辆的主动安全性能，减少交通事故的发生。车辆检测是自动驾驶系统环境感知模块中的一项重要任务，也是后续车辆决策规划、控制的基础。近年来，基于深度学习的方法成为了车辆检测的主流算法，其中以YOLO为代表的单阶段密集检测算法具有速度快，准确率相对较高的特点，在MS COCO等图像数据集上取得了优异的成绩。但目前车辆搭载的嵌入式设备算力比较有限，无法满足标准YOLO算法实时检测所需的算力要求；轻量化YOLO算法可以在嵌入式设备上实现实时检测，但检测准确度较差。如何提升轻量化车辆检测算法的准确度，是车辆检测算法部署过程需要面对的关键问题。

本文对YOLO系列算法理论知识进行了学习和分析，选取轻量化检测算法YOLOv3-Tiny作为基础算法，对其网络结构和训练策略进行了改进。具体包括，使用K-means++聚类算法对先验框进行了优化；对比不同网络结构对于算法性能的影响，选取了MobileNet作为改进算法的骨干网络，并增加了YOLO检测层数量至三层，由此提出了一种新的网络结构Mobile-YOLO-3；引入了GIoU Loss代替原有损失函数中的平均平方误差；使用Mosaic数据增强方法和多尺度训练策略。在BDD（Berkeley Deep Drive）数据集上进行了算法的训练，在Nvidia Jetson Nano上对算法的准确度和检测速度进行了测试。

实验结果表明，改进后的算法Mobile-YOLO-3相比原算法YOLOv3-Tiny在检测速度基本一致的情况下，准确度指标mAP-50由38.2%提升至45.5%，提升了超过7个百分点，改进效果显著。本文工作对于车辆检测算法在实际车辆上的部署具有重要的推动意义。

**关键词**：自动驾驶，车辆检测，YOLO，轻量化算法

**ABSTRACT**

Driving assistance systems and autonomous driving systems can effectively improve the active safety performance of vehicles and reduce the occurrence of traffic accidents. Vehicle detection is an important task of the environmental perception module of the autonomous driving system, and it is also the basis for subsequent decision planning and control modules. In recent years, the method based on deep learning has become the mainstream algorithm for vehicle detection. The single-stage intensive detection algorithm represented by YOLO has the characteristics of fast speed and relatively high accuracy, achieving good performance on image data sets such as MS COCO. However, the embedded device on the vehicle has limited computing power and cannot meet the computing requirements of the standard YOLO algorithm for real-time detection; the lightweight YOLO algorithm can achieve real-time detection on embedded devices, but the detection accuracy is not satisfying. How to improve the accuracy of lightweight vehicle detection algorithms is a key issue that the deployment of vehicle detection algorithms needs to face.

In this paper, the YOLO series of algorithms are theoretically studied, and the lightweight detection algorithm YOLOv3-Tiny is selected as the basic algorithm to improve. A new network structure has been proposed and several training strategies have been used to improve to the algorithm. Specifically, the K-means++ clustering algorithm is used to optimize the a size of anchor boxes; comparing the impact of different network structures on the performance of the algorithm, MobileNet is selected as the backbone network, and the number of YOLO detection layers is increased to three layers. A new network structure, Mobile-YOLO-3 has been proposed; use GioU Loss to replace the average squared error in the original loss function; uses Mosaic data enhancement method and multi-scale training strategy. Algorithm training was performed on the BDD (Berkeley Deep Drive) dataset, and the accuracy and detection speed of the algorithm were tested on the Nvidia Jetson Nano.

Experimental results show that compared with the original algorithm YOLOv3-Tiny, the improved algorithm Mobile-YOLO-3 improves the average accuracy mAP-50 from 38.2% to 45.5%, which is more than 7 improvements Percentage point, this is a significant improvement. The work of this paper is of great significance for the deployment of vehicle detection algorithms on actual vehicles.

**Key words**：autonomous driving, vehicle detection, yolo, lightweight algorithm

## 绪 论

### 课题研究背景与意义

汽车为人类带来了极大的便利，但随着汽车保有量的增加，交通拥堵与汽车安全性问题也十分突出。据国家统计局发布的统计数据显示，2017-2019年期间我国交通事故万车死亡人数逐年下降，但考虑到民用汽车保有量的增长，实际因交通事故死亡的人数逐年攀升，仅2019年一年就有约四万七千人因交通事故丧生。如何有效提高汽车的安全性能，规避驾驶风险并减少交通事故的发生成为亟待解决的问题。

<center> 表 1.1 2017-2019交通事故死亡人数 </center>

| 年份 | 民用汽车保有量/万辆 | 交通事故万车死亡人数/人 | 死亡人数估算/人 |
| ----------- | ----------- | ----------- | ----------- |
|2017|	21743|	2.06	|44791|
|2018|	24028|	1.93	|46374|
|2019|	26150|	1.80	|47070|

近年来，自动驾驶技术成为了学术界与工业界研究的热点，发展自动驾驶与智能网联汽车已成为汽车业界共识。自动驾驶或驾驶自动化技术具有多个技术等级，一般按照美国汽车工程师协会（Society of Automotive Engineers , SAE）推行的分类标准分为6个级别。目前市场上已推出了许多位于L1和L2级别的驾驶辅助技术，如自适应巡航系统ACC、车道保持辅助LKA等。从主被动安全的角度来看，这些驾驶辅助系统属于主动安全系统，能主动规避交通事故和具有风险的驾驶行为，在紧急工况下可以帮助驾驶员控制车辆，并在多种工况下减轻驾驶员的工作强度，因此可以有效地增加车辆的主动安全性能。随着自动驾驶或驾驶自动化技术等级的提高，汽车的安全性能将得到进一步提高。

自动驾驶技术可分为感知、决策、规划与执行几个部分，无论是驾驶辅助系统还是高级别自动驾驶技术的智能汽车，都缺少不了准确可靠的感知系统。自动驾驶的感知系统负责通过摄像头、激光雷达、毫米波雷达和惯性单元等传感器获取周围环境的信息，确保车辆能够正确识别和理解驾驶环境，为后续的规划、决策、控制系统提供关键信息。具体而言，感知系统的任务包括车辆检测、行人检测、车道线检测和交通标识识别等。在大多数的交通道路环境中，车辆目标的数量最多、对驾驶决策的影响最大，因此车辆检测是自动驾驶感知系统中的一项重要和关键任务。

在车辆检测任务中，常用方案包括基于摄像头图像的检测方案，基于激光点云的检测方案，以及利用两者数据进行传感器融合的方案。相比激光雷达，摄像头在成本与场景理解方面具有优势，因而基于摄像头图像的车辆检测算法也得到了较好的发展，例如在Tesla公司的Autopilot 自动辅助驾驶系统中，车辆各位置配备了共计8个摄像头作为感知系统的主力传感器，基于图像的视觉方案在感知系统中发挥了重要的作用。

目前，基于摄像头图像的车辆检测算法虽然取得了许多成就，但在实际部署过程中仍然面临着许多工程应用上的困难。
- 实际道路交通条件与天气条件复杂多变，摄像头成像容易受到光照和雨水影响，车辆目标检测能力显著下降，算法在面对复杂环境下的鲁棒性不足；
- 实际道路车辆目标外形尺寸多样，而且时常被遮挡，算法检测困难；
-  算法需要处理大量的图像信息数据，对算力的要求十分巨大。目前的自动驾驶样车上需要配备体积巨大的工控机以及配套散热设备才能满足算法运行时的算力需求，硬件的购置和维护成本非常高昂。算法对目前车辆的主流硬件配置而言并不适用，难以商业落地推广。
-  
因此，对于基于图像的车辆目标检测算法的研究具有十分重要的学术意义和工程价值，如何提升算法鲁棒性，减少算法所需的运算量是车辆目标检测算法中的关键性问题，对算法能否实际落地具有决定性的影响。

### 车辆目标检测发展概况

车辆检测任务包括目标定位与目标分类两个子任务。按照定位与分类的不同方法，车辆检测算法可以分为基于人工设计特征提取的检测算法，以及基于卷积神经网络（Convolutional Neural Network，CNN）的检测算法。其中基于卷积神经网络的算法又可以分为基于候选区域（Region Proposal）思想的两步算法（Two-Stage）和基于边框坐标值回归思想的单步算法（One-Stage）。

#### 基于人工特征提取的算法

该类方法可以分为区域分割、特征提取、目标分类三个步骤。首先使用滑动候选窗等分割方法对图像进行不同尺度的区域化分割，之后在各个图像区域中使用人工设计的外表特征和特征描述算子来从图像中提取车辆特征信息，例如颜色，对称性与边缘特征，最后结合机器学习中的分类器进行分类完成识别任务。

常用特征有HOG（Histogram of Oriented Gradient, HOG）特征、SIFT（Scale-invariant feature transform，SIFT）特征、Haar-like特征、Harris特征等；常用的分类器有SVM分类器、Adaboost分类器等。典型算法为可变型部件模型（Deformable Parts Models，DPM）和Haar Cascade等。

这类基于提取特征的方法在早期发展较为活跃，涌现出了一批效果较好的车辆检测算法。但该类检测算法具有一些系统性缺陷，例如人工设计的特征鲁棒性不够高，而且设计工作复杂缺少规律，提取过程较为复杂，与分类器配合的算法调优也比较困难。除此之外，使用滑动候选窗进行不同尺度区域分割得到的候选区域过多，大部分区域的检测并非有效检测，这使得算法需要的计算量非常庞大且运算十分低效，检测速度较慢，难以满足实时性检测的要求。由于这些缺陷，该类传统算法在目前的使用已经越来越少，基于卷积网络与深度学习的方法逐渐成为了主流方法。

<img src='hog_visualization.png' width = '800' title = 'hog visualization'>

#### 基于卷积神经网络与深度学习的检测算法

卷积神经网络以1998年LeNet-5的发布作为标志性开端。LeNet-5最早提出了卷积层，池化层与全连接层等基本组件的概念，实现了对图像中数字目标的分类任务。但受限于硬件条件，基于卷积神经网络的算法并没有得到大部分研究者的注意力，在后续十几年里也没有取得突破性进展。直到2012年，Alex对卷积神经网络提出了包括ReLu，Data Augmentation，Dropout等一系列的改进方法，推出了AlexNet。受益于硬件水平的提高，以及先进的优化方法，AlexNet夺得了当年图像识别比赛ILSVRC的冠军并将检测准确率记录大幅提高，从而引发了对卷积神经网络的研究热潮，出现了诸多的网络架构与优化方法。VGG通过将全连接层替换为卷积层，解除了对于输入图片尺寸的限制。ResNet[9]提供了通过残差链接（Residual Connection）实现深层网络的思路，有效缓解了由于层数累计造成的梯度爆炸（Gradient Exploration）或梯度消失（Vanishing）问题，使得卷积神经网络深度可以突破100层，残差连接成为了后续深度学习算法的常用组件之一。DenseNet进一步扩展残差连接的思路，增加了层与层之间的连接，取得了出色的成绩。

基于卷积神经网络的目标检测领域进展也十分繁荣，可以按照目标检测两个子任务的完成顺序的不同，分为基于候选区域的两步方法和基于回归思想的单步方法。

前者以R-CNN算法作为代表，通过选择性搜索（Selective Search）选取候选区域的方法取代了传统利用滑动窗分割图像的方法，有效减少了滑动窗选取带来的过多的区域数量，完成了目标的定位。后续的分类任务则使用卷积神经网络作为分类器进行分类，整个过程将目标检测的两个子任务分开完成，因此称作两步（Two-Stage）方法。在R-CNN提出之后，研究者们通过改进选取方法，又出现了Fast R-CNN、Faster R-CNN、Libra R-CNN等改进型网络，Fast R-CNN提出了锚盒（Anchor Box）的概念，在目标检测领域中得到了广泛的使用；Faster R-CNN使用ROI pooling层解决了卷积计算中大量重复计算的问题，使得算法在速度方面有了很大提高。除了上述算法，不需要Anchor Box的RepPoints也属于两步检测方法。

单步检测方法则以2016年提出的YOLO[2]算法作为代表，该网络创新性地将目标检测处理为检测框的回归问题，只需要一个卷积神经网络就可以完成目标检测的全部任务，不需要对图像进行候选区域分析，因而称为单步（One-Stage）方法，在初代YOLO之后，YOLO9000[3]与YOLOv3[4]分别于2017年和2018年被提出，在算法的精确度上有所提升。2020年4月，Alexy等推出了YOLO算法的最新版本YOLOv4[5]，引入了近些年来诸多先进目标检测算法的新颖特性和若干创新性的训练策略，在MS COCO数据集上取得了十分出色的成绩，相较于前代算法准确度有了很大的提高。该类代表性网络还有SDD[11]。

相比R-CNN等两步检测算法，单步检测算法结构更为简洁，需要的计算量较小。算法在保持了较好的准确度的情况运算速度也相比两步算法提升很大，YOLOv3比Fast R-CNN快100倍，在大部分场景下也显著快于Faster R-CNN。除此之外，除了YOLOv4外每代YOLO都推出了轻量化版本的算法，相比标准版本的算法，轻量化版本的算法检测准确率相对较低，但运算量也大幅降低，更适合部署于硬件受限的工业化场景，例如部署在车辆和无人机的嵌入式平台上，这和自动驾驶车辆检测算法目前的部署需求非常契合。

基于卷积神经网络的方法，相较于传统的基于人工设置特征的方法取得了较大的突破，已经成为目前主流的目标检测方法，但对于处理需要应用到自动驾驶的车辆目标检测问题上，仍然存在一些问题：首先是在精度和算法鲁棒性上对于复杂多变的道路环境而言仍有不足，其次考虑到实际应用场景下车辆硬件计算水平，大部分网络的计算成本仍然过高，难以进行实时性运算，目前进行路试的自动驾驶测试车辆上搭载的工控机设备的成本对于车辆而言过于高昂，距离技术最终商业化落地仍然有较长的距离。

### 本文的研究内容

本文针对车辆目标检测任务进行研究，目的在于提出可以在复杂交通环境下快速、准确检测出车辆目标的轻量化算法，推动车辆目标检测算法在嵌入式设备上的精度和速度，具有重要的学术研究意义与工程价值。

具体而言，本文的研究内容包括：

在专用于自动驾驶训练与测试的数据集BDD（Berkeley Deep Drive）[8]上对现有的轻量化目标检测算法进行训练与测试。

以YOLO系列算法为基础进行了算法的改进工作，通过实际测试选取出最优的网络架构。对多种训练策略与后处理方法进行测试，研究适用于车辆目标检测的最佳改进算法方案。

在嵌入式设备Nvidia Jetson Nano上部署算法，以验证算法计算量是否允许在嵌入式平台上运行。

### 本文结构

本文正文部分共分为五个章节，下面分别介绍各章的主要内容。

第一章，绪论。阐明课题研究的背景意义，叙述课题研究领域的发展概况，介绍主要的研究内容和目标，并对全文结构进行说明。

第二章，介绍神经网络以及卷积神经网络的基本结构、建模原理、训练方法等。从基于区域建议与基于回归的两大类中选取了代表性算法R-CNN、YOLO、SSD进行了简要分析。 

第三章，对YOLO算法进行了理论分析，讨论了算法的评价方法并对比YOLO系列算法的性能。选取了YOLOv3-Tiny作为改进算法的基础算法。

第四章，通过对网络架构的重新设计，提出了一种新的改进型车辆检测算法，并从激活函数和损失函数的角度对算法进行了优化设计。在实际嵌入式开发平台Nvidia Jetson Nano上对算法进行了部署和测试，测试各算法的实际运行速度并进行了对比。

第五章，总结与展望。对全文的工作进行了回顾与总结，分析了算法存在的不足，对进一步的工作进行了展望。

## 神经网络与目标检测

### 引言

本章介绍研究内容的基础知识。首先介绍神经网络与卷积神经网络的基本结构，之后将对目标检测算法的通用模型与典型算法进行分析和介绍。

### 机器学习与人工神经网络

机器学习是一种能够通过数据驱动训练自主生成模型的方法。机器学习所使用的数据称为样本，样本的属性称为特征，若样本归属某个类别，则该类别称为样本的标签。按照训练数据是否具有标签，机器学习方法可以分为有监督机器学习和无监督机器学习。有监督机器学习又分为线性回归、逻辑回归、支持向量机、人工神经网络等，无监督机器学习则主要包括聚类、异常识别等。

人工神经网络（Artificial Neural Network），也常简称神经网络，是有监督机器学习中的一种建模方法，它借鉴了生物中神经系统的概念，基本组成单元为神经元模型，并据此建立了由神经元组成的网络结构。

神经元模型参照神经系统中神经元细胞的结构与工作原理，包括输入、神经元、输出三个部分。输入可以看作是神经元细胞中的树突，负责接收传递至神经元的信息，神经元负责对输入的信息进行计算，并被“激活”输出信息至后续神经元。，输出的部分可以类比于神经元细胞中的轴突。图2.1是一个典型的神经元模型，包含有两个输入信号和一个输出信号，以及负责运算的神经元结构。

<img src='neuron.png' width = '800' title = 'neuron model'>

将输入信号设为x1，x2，输出信号设为y，输入信号的权重设为w1、w2，偏置设为b，激活函数设为σ，则该神经元的输出如式$(2.1)$所示为

$$
y = \sigma (w_1*x_1+w_2*x_2+b) \tag{2.1}
$$

神经元模型是神经网络中最基础的模块，就像神经系统由许许多多神经元相互连接而成，人工神经网络中一个神经元的输出也可以作为下一个神经元的输入，各神经元彼此连接，构成人工神经网络的结构。使用不同的方法来连接神经元可以得到结构不同的神经网络。通常将神经网络中每一个神经元对应的权重和偏置值称为神经网络的参数。参数量决定着神经网络的规模。

神经网络的输入和输出可以看作一种函数映射关系，改变神经网络中神经元的参数就可以得到可能完全不同的映射关系，把这些可能的映射关系汇聚在一起，就得到了一个由神经网络结构产生的映射的集合。

一种常见的连接方式就是将每一层所有神经元的输出都连接到下一层所有神经元的输入，这样构成的网络称为全连接网络（Fully Connected Network）。如果将每一个神经元抽象成一个圆球，只保留连接，构成的神经网络示意图如下，包括输入层、隐藏层和输出层。

<img src='fully_connectoed.png' width = '800' title = 'fully connectoed neural network'>

全连接网络的前向传播，如式$(2.2)$

$$
y_i  = \sum^n_{j=1} w_ij*xj+bi \tag{2.2}
$$

其中，y_i为后一层网络的输出，x_j为前一层网络的输入，w_ij为不同连接上的权重，b_i为不同神经元上的偏置。此外，神经网络的运算也可以看作是矩阵的运算，如式$(2.3)$

$$
Y = WX+B \tag{2.3}
$$

其中，Y为网络的输出向量，X为网络的输入向量，W为不同连接上的权重矩阵，B为不同神经元上的偏置向量。矩阵运算的一个好处就是可以使用GPU进行加速。利用GPU加速可以大大加快神经网络的训练速度。

神经网络的输入层是样本的特征，输出层则按照需要可以有多种形式，对于逻辑分类问题则每个神经元代表样本归属类别的该类，对于回归问题则代表回归值。在神经网络输入层和输出层之间的网络统称为隐藏层。一般而言，对于确定的问题，输入层和输出层的结构是确定的，而隐藏层的结构则全部由网络设计者确定，隐藏层的结构包括神经元的数量、隐藏层包含层数、神经元连接方式，一般而言，隐藏层的深度决定着神经网络的参数数量和复杂度。对于隐藏层深度很深的网络，也将该网络的学习训练过程称为深度学习。

神经网络的训练过程将在卷积神经网络中进行详细介绍。

### 卷积神经网络

#### 卷积神经网络的基本结构

卷积神经网络是人工神经网络的一个子类别。被广泛地应用于计算机视觉领域。

卷积神经网络最早以LeCun提出的LeNet-5作为结构范本，输入层（Input Layer）之后隐藏层包括卷积层（Convolutional Layer）、池化层（Pooling Layer）和全连接层（Fully Connected Layer），同时以全连接层作为输出层（Output Layer）。

<img src='lenet5.png' width = '800' title = 'LeNet-5'>

LeNet-5结构如图所示，以图像像素作为输入，随后卷积层和池化层（下采样层）交替出现，最后加入全连接层作为输出层。在卷积神经网络后续发展中出现了批归一化层（Batch Normalization，BN）和残差层（Residual Layer）等新型网络层级结构。下面对卷积神经网络中的各层级进行简单介绍。

##### 输入层

输入层一般为图像。对于图像，输入层的参数除了包括以像素为单位的宽度、高度尺寸外，还有图像的通道数目，对于灰度图像通道数为1，对于RGB图像通道数为3。

<img src='rgb.png' width = '800' title = 'input image'>

##### 卷积层

卷积层是卷积神经网络的核心和主要组成部分，主要用于提取图像特征。在卷积神经网络，中间层的数据也被称为特征图（Feature Map），通过设置若干个卷积核（Kernel）与特征图进行类卷积运算，可以得到新的特征图后输出。

<img src='convlution.png' width = '800' title = 'convolutional layer'>

层包含的参数有：卷积核参数（Kernel），步长（Stride），填充像素（Padding）,其中可训练参数为卷积核参数。对于输入特征图通道数D_1  ，为宽高尺寸为"W×H" 的卷积层来说，若卷积核尺寸为"m×n" ，数目为D_2，步长设为s，填充值设为p，输入层值用$f(ii,jj,d_1)$表示，卷积核参数值为$k_{d_r}(u,v,d_1)$ ，输出层值用$g(i,j,d_2) $ 表示，则存在如下关系：

$$
g(i,j,d_2 )=\sum_{d_1=1}^{D_1}\sum_{u=1}^m\sum_{v=1}^m k_{d_2}(u,v,d_1 )*f( (i-1)*s+u,(j-1)*s+v,d_1) 
\tag{2.4}
$$

输入与输出特征图尺寸关系为:
$$
W_{out}= floor(\frac{W+2p-m}{s})+1 \tag{2.5}
$$
$$
H_{out}=floor(\frac{H+2p-n}{s})+1 \tag{2.6}
$$

卷积层是卷积神经网络能够实现局部感知和权值共享特性的原因。局部感知是指，输出特征图上每一个点的值都只与输入特征图对应位置局部的值有关，这片区域也被称为感受野（Rceptive Field），类比于人类观察事物时的视野范围，通常感受野越大卷积层提取到的特征就越全面和整体。权值共享，则通过卷积核在输入特征图上的平移来实现，指的是前后层不同的神经元节点连接参数共享。这两个特性使得卷积神经网络相比原本全连接的神经网络大大减少了参数数量，使其能够有效处理图像像素这种输入规模庞大的数据。

##### 激活层

激活层（Activation Layer）通常也被称作激活函数，主要作用是增加网络的非线性函数表达能力。激活层通常跟在卷积层或批规范化层之后缺乏激活函数的神经网络只能表达线性模型，加深网络层数并不能提高网络的建模能力。激活函数的常用形式有Sigmoid，tanh，ReLu（Rectified Linear Unit）及其变体Leaky-ReLu，Mish等。

<img src='active.png' width = '800' title = 'activation function'>

Sigmoid和tanh是常见的激活函数，表达式如下。它们形状类似，主要特点是能够将输出量限制在（0，1）和（-1，1）的区间之内，梯度都在0处最大，并向两侧迅速衰减。这使得输入容易进入梯度饱和区，使得反向传播时的使用链式法则计算的梯度也会接近0，即产生梯度消失或者梯度弥散现象（Gradient Vanishing），使得训练的进展十分缓慢。

$$
\sigma({x})=\frac{1}{1+e^{-x}} \tag{2.7}
$$

$$
tanh⁡(x)=\frac{e^x-e^{-x}}{e^x+e^{-x}} \tag{2.8}
$$

ReLU的表达式为：
$$
ReLu(x)=max⁡(x,0)
$$

在输入值大于0时，输入与输出相等，导数结果恒为1，简化了计算梯度的过程，同时也避免了梯度消失的问题，因此能够加速收敛过程。但它在输入值为负的区间梯度恒为零，有可能造成负值梯度恒为零的情况，即发生神经元失活的情况。ReLU拥有许多变体函数，如Leaky-ReLU、P-ReLU和Mish，这些激活函数的共同特点是通过保持函数输入正半轴区间不变，修改输入小于零时的函数表达式，由此可以取得更好的激活效果。但这些变种函数也增加了计算量，使网络的训练变得困难。

##### 批归一化层
除了梯度消失，另一种深层网络可能遇到的问题是梯度爆炸（Gradient Explosion），它发生在初始化权重过大时，反向传播计算梯度时由于链式法则各项大于1，会计算得到数值巨大的梯度值，造成模型发散从而训练失败。使用批归一化层（Batch Normalization）可以有效减少协方差偏移，保持梯度值稳定在合理区间，从而有效抑制梯度爆炸和梯度弥散的发生。同时批处理还具有一定的正则化能力，它为每个隐藏层增加了一些噪音，可以减少模型的过拟合趋势。

批归一化层对数据的处理分为两个步骤。首先是对数据进行归一化处理，减去数据批平均值并除以批标准差，但仅简单的对数据进行归一化通常不能得到最优梯度，从而影响网络的稳定性，因此BN层设置了两个可以学习的参数γ与β，在归一化处理后再利用这两个参数进行反归一化，通过训练使归一化效果与最佳梯度达到一种平衡。

批归一化层经常与卷积层、激活层在一起出现，按照卷积层-归一化层-激活层的顺序作为一个整体的“卷积块”被使用。 

##### 池化层
池化层又被称作降采样层，池化层本身不含有可训练参数，主要作用是从输入的特征图中筛选或提取特征，通过调整参数可以起到缩小特征图尺寸的作用。池化层一般分为两种类型，平均池化（mean Pooling）与最大池化（max Pooling）。若池化层所用的滤波器为k*k，平均池化是在k*k的区域内对特征值求平均并输出，可以视为融合该区域特征并提取；最大池化是选择k*k区域内的最大值，可以理解为提取区域内最为明显的特征。
 
<img src='pooling.png' width = '800' title = 'pooling layer'>

若输入特征图通道数D ，为宽高尺寸为W×H，池化滤波器尺寸为m×m，步长设为s，填充值设为p，则输出特征图通道数不变，宽高尺寸为：
$$
W_{out}= floor(\frac{W+2p-m}{s}+1 \tag{2.10}
$$
$$
H_{out}= floor(\frac{H+2p-m}{s}+1 \tag{2.11}
$$
上式表明，通过池化操作可以获得下采样的效果。相比使用卷积层进行下采样，在面对特征可能发生旋转或平移变换等移动时，池化层的效果鲁棒性更好，这种特性称作局部平移不变性。

##### 残差层
残差层的概念来自于残差神经网络ResNet，其为构建深层卷积神经网络提供了方法和思路，该网络的提出被视为卷积神经网络发展中的里程碑式事件。

对于卷积神经网络而言，更深的层数通常意味着更多可以训练的参数，也意味着该网络可以表达更为复杂的函数模型。但研究表明，如果仅仅是通过堆叠卷积层来达到加深网络，在超过某一深度阈值后，网络的训练误差与测试误差均会随着网络加深而变大，发生“网络退化”现象。出现这一现象的原因有诸多理论和猜想，其中一种认为是因为这种简单堆叠形成的“平坦网络”缺乏学习恒等映射的能力，在原本浅层网络已经可以较好表达系统的形况下，加深网络会迫使网络改变映射，造成原本语义清晰的浅层特征抽象化，从而增大了误差。

为了解决这一问题，何凯明等人提出了包含残差块的残差网络，残差块的基本结构如下。

<img src='res.png' width = '800' title = 'resblock'>

图中右侧的曲线称为跳接（Shortcut Connection），它在激活层之前将上一层的输出结果F(x)与原输入数据x相加，将和作为残差层输出y，并将网络的学习目标变为寻找残差F(x)=y-x为0，从而使网络拥有学习恒等映射的能力。
$$
y=F(x)+x \tag{2.12}
$$
除了恒等映射，残差块也增加了网络的鲁棒性和泛化能力，研究表明去除任意一个残差块对于网络的表现影响很小，而VGG网络中若去除某一层就会造成网络表现断崖式下降。
基于这些原因，残差块或残差层在如今的卷积神经网络包括目标检测网络中应用非常普遍，已成为标准网络组件之一。

##### 输出层
输出层即输出网络预测结果的层级，经典的卷积神经网络通常采用全连接层的神经元结果加之Sigmoid或Softmax函数处理后输出。其中，Sigmoid在前述激活函数中提到可以限制输出在(0,1)区间，因此通常被用于二元分类（Binary Classification）问题，而Softmax函数表达式如下，其特点为各输出项加起来和为1，适用于多类别分类（Multi-Class Classification）问题。

$$
Softmax(s_i )=\frac{e^{s_i}}{\sum_j^n * e^{s_j}} \tag{2.13}
$$

#### 卷积神经网络的训练
卷积神经网络的训练属于有监督性学习，包括正向传播和反向传播两部分。

##### 正向传播
对于学习样本$(x,y)$，正向传播指输入样本x按照深度顺序，经过卷积、池化等一系列网络各层级得到输出$y^'$，并与样本标签$y$计算损失的过程。从图像特征的角度来看，正向传播是浅层网络的简单特征逐渐抽象化，产生得到深层网络的复杂特征的过程。

##### 反向传播
反向传播是利用梯度下降的原理，使用链式法则计算出各参数对损失函数的梯度并更新参数，到达极小值位置，从而达到降低网络损失，提高网络表现的目的。反向指的是梯度计算过程中应用的链式法则，计算顺序为深至浅，最先计算正向传播的输出$y^'$与$y$的残差，之后以此为基础计算梯度并更新各层级的参数，这与正向传播计算顺序相反。

<img src='sgd.png' width = '800' title = 'gradient descent'>

在反向传播中，需要选择梯度下降的策略或者说优化器。优化器的种类非常丰富，一直以来是学术界的研究热点。随机梯度下降（Stochastic Gradient Descent，SGD）是最经典的优化器，也是其他改进型优化器的基础。

$$
g=\frac{1}{m}\nabla_θ \sum_i^m Loss(f(x ; θ),y_i)) \tag{2.14}
$$
$$
θ=θ-ηg \tag{2.15}
$$

在训练中，梯度下降的步长控制是优化器能否较好完成工作的关键控制。下降步长过小，则训练速度太慢，影响训练的效率；下降步长过大，则有可能无法收敛。梯度下降大小对收敛的影响如图$2.10$所示。

<img src='descent.png' width = '800' title = 'gradient descent step'>

动量优化器（Momentum）在SGD的基础上，在梯度项中增加了原参数乘以$\alpha$的部分，这使得梯度拥有了类似于物理概念中动量的性质，若当前梯度下降方向与原方向一致则加快下降幅度，若方向相反则会减缓下降幅度。这有效的增加梯度下降的速度，避免陷入局部最小值。
$$
v=αv-ηg \tag{2.16}
$$
$$
θ=θ+v \tag{2.17}
$$

AdaGrad从学习率$\eta$入手，考虑到随着训练进度损失函数的数值会越来越小，如果保持学习速率不变，容易造成梯度下降过大而发生振荡不易收敛，因而AdaGrad为学习速率增加了衰减因子$s$，累计了所有更新的梯度值的平方，使得学习率随着学习进度而减小。
$$
s=s+g^{T}g \tag{2.18}
$$
$$
θ=θ-\frac{1}{\sqrt{s+ϵ}}\eta g \tag{2.19}
$$

RMSProp与AdaGrad的思路类似，不同之处在于它考虑到了不同时期梯度大小对梯度甩技能的影响应该不同，学习率的衰减因子应该受临近几次梯度的影响更大一些。
$$
s=decay*s+(1-decay)×g^Tg \tag{2.20}
$$
$$
θ=θ-\frac{1}{\sqrt{s+ϵ}}\eta g \tag{2.21}
$$
Adam优化器结合了Momentum和RMSprop的思想，汇聚了两者的优点，同时对学习率和动量进行了调节。
$$
s=decay×s+(1-decay)×g^T g \tag{2.22}
$$
$$
m=α_1 m+(1-α_1 )g \tag{2.23}
$$
$$
θ=θ-\frac{1}{\sqrt{s+ϵ}}\eta g \tag{2.24} 
$$
通过试验发现，Adam一般来说拥有最好的训练效果和收敛速度，得到了最为广泛的应用。

### 目标检测网络基本结构

目前流行的目标检测网络通常由骨干网络，检测器头部以及一些额外的模块组成，这一小节将对目标检测网络的基本结构进行梳理，并重点介绍YOLO系列网络的检测器。

<img src='yolo-all.png' width = '800' title = 'yolo detector'>

#### 网络基本结构

##### 骨干网络
骨干网络如名字一般，指的是目标检测网络中的主要组成部分，一般由卷积层、批归一化层、激活层、残差层组合而成。骨干网络的主要作用是提取图像中的特征信息，并交给后续的检测器部分进行识别。具有代表性的骨干网络有VGG、ResNet、DenseNet、Darknet等。

##### 检测器

检测器部分是目标检测网络的核心，按照前述目标检测网络的执行步骤数量也可以将检测器分为对整张图像进行密集预测的One-Stage类别和只在候选区域进行稀疏检测的Two-Stage类别。One-Stage类别网络的代表有YOLO、SSD，Two-Stage则以R-CNN系列为代表。

##### 特征融合与其他模块

除了骨干网络与检测器，还有一些额外的模块在目标检测网络中得到使用，例如YOLOv3中借鉴特征金字塔（Feature Pyramid Network，FPN）使用的特征融合模块，以及在YOLOv4中使用的路径聚合（Path Aggregation Network，PAN）模块都实现了不同深度层特征的融合，提高了检验的准确度；YOLOv3[5]使用的空间金字塔池化（Spatial Pyramid Pooling，SPP）模块则帮助网络能够处理任意维度的输入图像。这些模块被通常放置在骨干网络与头部检测器之间，提高网络的表现。

#### 两阶段目标检测器

两阶段检测方法将目标检测的问题处理为分类问题，充分利用深度学习在分类方面的优势来提高目标检测器的性能。该类别检测器以R-CNN及其改进型为代表，由于只对特定的候选区域进行检测，该类算法属于稀疏目标检测器。

##### R-CNN算法

R-CNN算法使用选择性搜索的方法评估图像的相似度，并将相似度高的区域进行合并操作，一张图像可以得到大约2000个候选区域。得到候选区域后，使用卷积神经网路对特征进行提取，再使用支持向量机对候选区域进行分类训练，并对目标候选框的坐标进行回归预测，最终完成目标检测任务。相比传统采用滑动窗口遍历图像的方法，R-CNN的选择性搜索算法可以筛选出概率更大的区域，减少不必要的计算量。

<img src='r-cnn.png' width = '800' title = 'r-cnn'>

##### Fast R-CNN算法

<img src='fast r-cnn.png' width = '800' title = 'fast r-cnn'>

由于R-CNN算法检测一张图像需要运行2000次左右的卷积神经网络的正向卷积运算，仍然有较大的运算量。Fast R-CNN提出了ROI pooling池化层结构，只需对图像进行一次特征提取就能得到每个候选框的深度特征，之后再输出到全连接层进行边界框坐标的回归和目标分类。ROI pooling使得算法的速度大大提高了

##### Faster R-CNN算法

<img src='faster-rcnn-global.png' width = '800' title = 'faster r-cnn'>

在Faster-RCNN中，改变了候选区域的搜索方式，不再使用选择性搜索算法，而采用卷积神经网络来提取目标特征并得到候选区域，该网络被称为区域建议网络（Regional Proposal Network，RPN），它能够提高候选区域的准确度，进而提高整体检测的准确度。RPN并没有使用额外的骨干网络，而是与负责分类任务的网络共享卷积权重，因而对整体的时间成本影响并不大。


#### 单阶段目标检测器

单阶段检测器的代表网络有YOLO与SSD。该类检测器的特点是不需要先选取候选区域对目标进行初步定位，而是直接将定位和分类任务都使用一个卷积网络来完成，预测速度相比两步类检测器有了飞跃。该类算法属于密集预测类别的检测器。

##### YOLO

YOLO系列算法将图像划分为等尺寸的网格区域，每个网格区域负责中心点落在区域内的目标的检测任务，并在输出层YOLO层中直接输出边界框和目标类别的预测值，使得目标的定位与分类任务仅需要运行一次前向卷积网络即可完成。因此相比于两步的目标检测算法，YOLO的速度优势比较明显。

<img src='yolo-grid.png' width = '800' title = 'yolo-grid'>

按照网络的规模和参数量级，YOLO系列算法分为标准版和轻量化版，轻量化版本的YOLO算法精确度相比标准版本相对较低，但检测速度得到了进一步的提升，在硬件设备受限的工业界得到了较为广泛的应用。目前标准版已经更新到了第四代版本YOLOv4，轻量化最新版本为YOLOv3-tiny。

##### SSD

SSD，全称为Single Shot MultiBox Detector[11]。名字中的Single Shot表明它与YOLO类似，采用单卷积网络的回归方法，MultiBox指明了它的主要创新点是采用了多尺度下的目标检测。SSD相比YOLO的前两个版本，优势在于共计6个不同尺度的网络层级上都进行了目标检测，从而增强了对不同尺度目标检测的鲁棒性。在YOLOv3中也使用特征金字塔结构实现了多尺度的检测。

<img src='ssd.png' width = '800' title = 'ssd'>

### 本章小结

本章从神经网络的基本结构神经元开始，对神经网络以及卷积神经网络的基本结构、建模原理、训练方法等方面进行了分析介绍。针对基于卷积神经网络的目标检测算法，本章进行了详细的讨论，从基于区域建议与基于回归的两大类中选取了代表性算法R-CNN、YOLO、SSD进行了简要分析，从中得到了两类算法的区别与优缺点。