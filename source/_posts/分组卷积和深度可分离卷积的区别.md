---
title: 分组卷积和深度可分离卷积的区别
mathjax: true
date: 2021-04-02 20:46:55
tags:
- pytorch
- 机器学习
categories: 机器学习
---

辨析一下两种有些类似的卷积方式

<!-- more -->

## 分组卷积

分组卷积只有一次卷积，只要设置nn.Conv2d里面的group选项即可，分组之前原本需要$c_1*c_2*k*k$，所有的输入channel都与输出的每一个channel相关；分组之后，输入输出分为g组，每一组的输入channel只需要负责本组的输出channel，因此计算量变为

$$g*\frac{c_1}{g}*\frac{c_2}{g}*k*k$$

变为了原来的1/g倍，有效减少了卷积计算量


```py
class Conv(nn.Module):
    # convolution module: conv2d+bn+relu
    # ch_in, ch_out, kernel_size, padding, group
    def __init__(self,c1, c2, k=1, s=1, p=None, g=1, act='relu'):
        super(Conv,self).__init__()
        self.conv = nn.Conv2d(in_channels=c1, out_channels=c2, kernel_size=(k,k), stride=(s,s), padding=autopad(k, p),  groups=g, bias=False)
        self.bn = nn.BatchNorm2d(c2)
        act_dict = {'relu':nn.ReLU(),'leaky':nn.LeakyReLU(), 'gelu':nn.GELU(), 'silu':nn.SiLU(), 'sigmoid':nn.Sigmoid(), 'tanh':nn.Tanh(), 'identity':nn.Identity()}
        self.act = act_dict[act]

    def forward(self,x):
        return self.act(self.bn(self.conv(x)))
```

-----

## 深度可分离卷积

深度可分离卷积实际上是两次卷积

第一次depth-wise只在每个channel上使用$k*k$的kernel卷积，由$c_1$得到$c_1$个单独的channel (分组g设置为$c_1$,保证一个kernel只作用一个channel)。
参数量：

$$g*\frac{c_1}{g}*\frac{c_1}{g}*k*k$$

第二次point-wise让每一个$c_1$个里channel，使用1*1的卷积核，只为了改变channel数目为$c_2$（分组g设置为1，让每一个输入都与输出channel有关）

参数量：

$$c_1*c_2*1*1$$

总参数量:

$$g*\frac{c_1}{g}*\frac{c_1}{g}*k*k + c_1*c_2*1*1$$

```py
class DWConv(nn.Module):
    # Depth-wise separable convolution
    def __init__(self, c1, c2, k=1, s=1, p=None, act='relu'):
        super(DWConv, self).__init__()
        self.depthwise = nn.Conv2d(c1, c1, (k,k), (s,s), padding=autopad(k, p), groups=c1, bias=False)
        self.pointwise = nn.Conv2d(c1, c2, (1,1), (1,1), padding=autopad(1, p), groups=1, bias=False)
        act_dict = {'relu':nn.ReLU(),'leaky':nn.LeakyReLU(), 'gelu':nn.GELU(), 'silu':nn.SiLU(), 'sigmoid':nn.Sigmoid(), 'tanh':nn.Tanh(), 'identity':nn.Identity()}
        self.act = act_dict[act]

    def forward(self, x):
        return self.act(self.pointwise(self.depthwise(x)))
```

## 总结

两者在代码实现上有些类似，或者说深度可分离卷积在depth-wise方面是分组卷积的一种特殊形式（c1=c2，g=c1）。应该抓住深度可分离卷积是两次卷积的特点进行区分

